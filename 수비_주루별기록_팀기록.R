
#############################################################################################################
#############################################################################################################
#############################################################################################################
##                          Selenium 시작                   #################################################
#############################################################################################################
#############################################################################################################
#############################################################################################################
#############################################################################################################


#install.packages("RSelenium")
#install.packages("wdman")
library(RSelenium)
library(wdman)
library(dplyr)
library(magrittr)
library(rvest)




driver<- rsDriver(port=4445L,browser = "chrome",verbose = FALSE, check = FALSE)

remDr <- driver$client

defense_team_base_record = list()
runner_team_base_record = list()


for(i in 1:18){
  
  Sys.setlocale("LC_ALL", "English")



    #############################################################################################################
    #############################################################################################################
    #############################################################################################################
    ##                    수비정보       crwaling                               ################################
    #############################################################################################################
    #############################################################################################################
    #############################################################################################################
    #############################################################################################################
    
    
    remDr$navigate("https://www.koreabaseball.com/Record/Team/Defense/Basic.aspx")
    
    
    #############################################################################################################
    #############################################################################################################
    #######################                       시즌정보 확인                 #################################
    #############################################################################################################
    #############################################################################################################
    #############################################################################################################
    
  
    season_select <- remDr$findElement(using = 'xpath', value = sprintf('//*[@id="cphContents_cphContents_cphContents_ddlSeason_ddlSeason"]/option[%s]',i))
    
    season_select$clickElement()
    
    Sys.sleep(2)
    
    
    selectelem <- remDr$findElement(using = "xpath", '//*[@id="cphContents_cphContents_cphContents_ddlSeason_ddlSeason"]')
    
    
    season_value = selectelem$getElementAttribute("value")[[1]]
    
    webElem <-remDr$findElement(using = "class", value = "record_result")
    results <- webElem$getElementText()
    
    webElem5txt <- webElem$getElementAttribute("outerHTML")
    
    page_source <- remDr$getPageSource()
    
    data_basic_1_1 = read_html(page_source[[1]]) %>% html_nodes("table") %>% html_table() %>% extract2(1)
    
    temp_df = data.frame(season=season_value,data_basic_1_1)

    colnames(temp_df)[2] = "순위"
    colnames(temp_df)[3] = "팀명"
    
    Sys.setlocale("LC_ALL", "Korean")
    
    defense_team_base_record[[i]] = temp_df[-nrow(temp_df),]

}

######################################################################
#####       데이터 저장 ##############################################
######################################################################



write.csv(bind_rows(defense_team_base_record),"~/defense_team_base_record.csv",row.names = FALSE)






for(i in 1:18){
  
  Sys.setlocale("LC_ALL", "English")
  
  
  
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  ##                    주루정보        crwaling                               ################################
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################

  
  remDr$navigate("https://www.koreabaseball.com/Record/Team/Runner/Basic.aspx")
  
  #############################################################################################################
  #############################################################################################################
  #######################                       시즌정보 확인                 #################################
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  
  
  season_select <- remDr$findElement(using = 'xpath', value = sprintf('//*[@id="cphContents_cphContents_cphContents_ddlSeason_ddlSeason"]/option[%s]',i))
  
  season_select$clickElement()
  
  Sys.sleep(2)
  
  
  selectelem <- remDr$findElement(using = "xpath", '//*[@id="cphContents_cphContents_cphContents_ddlSeason_ddlSeason"]')
  
  
  season_value = selectelem$getElementAttribute("value")[[1]]
  
  webElem <-remDr$findElement(using = "class", value = "record_result")
  results <- webElem$getElementText()
  
  webElem5txt <- webElem$getElementAttribute("outerHTML")
  
  page_source <- remDr$getPageSource()
  
  data_basic_1_1 = read_html(page_source[[1]]) %>% html_nodes("table") %>% html_table() %>% extract2(1)
  
  temp_df = data.frame(season=season_value,data_basic_1_1)
  
  colnames(temp_df)[2] = "순위"
  colnames(temp_df)[3] = "팀명"
  
  Sys.setlocale("LC_ALL", "Korean")
  
  runner_team_base_record[[i]] = temp_df[-nrow(temp_df),]
  
}

######################################################################
#####       데이터 저장 ##############################################
######################################################################



write.csv(bind_rows(runner_team_base_record),"~/runner_team_base_record.csv",row.names = FALSE)



## 셀레니움 종료

remDr$close()

## 드라이버 사용종료

rm(driver)

## 메모리 삭제

gc()