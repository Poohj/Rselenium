
#############################################################################################################
#############################################################################################################
#############################################################################################################
##                          Selenium 시작                   #################################################
#############################################################################################################
#############################################################################################################
#############################################################################################################
#############################################################################################################


#install.packages("RSelenium")
#install.packages("wdman")
library(RSelenium)
library(wdman)
library(dplyr)
library(magrittr)
library(rvest)




driver<- rsDriver(port=4445L,browser = "chrome",verbose = FALSE, check = FALSE)

remDr <- driver$client

hitter_team_base_record <- list()


for(i in 1:18){
  
  Sys.setlocale("LC_ALL", "English")

  
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  ##                    기본기록 첫번째 crwaling                               ################################
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  
  
  remDr$navigate("https://www.koreabaseball.com/Record/Team/Hitter/Basic1.aspx")

  #############################################################################################################
  #############################################################################################################
  #######################                       시즌정보 확인                 #################################
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  
  season_select <- remDr$findElement(using = 'xpath', value = sprintf('//*[@id="cphContents_cphContents_cphContents_ddlSeason_ddlSeason"]/option[%s]',i))
  
  season_select$clickElement()
  
  Sys.sleep(2)
  
  
  selectelem <- remDr$findElement(using = "xpath", '//*[@id="cphContents_cphContents_cphContents_ddlSeason_ddlSeason"]')
  
  
  season_value = selectelem$getElementAttribute("value")[[1]]
  

  webElem <-remDr$findElement(using = "class", value = "record_result")
  results <- webElem$getElementText()
  
  webElem5txt <- webElem$getElementAttribute("outerHTML")
  
  page_source <- remDr$getPageSource()
  
  data_basic_1_1 = read_html(page_source[[1]]) %>% html_nodes("table") %>% html_table() %>% extract2(1)
  
  data_basic_1_1 = data.frame(season=season_value,data_basic_1_1)
  
  colnames(data_basic_1_1)[2] <- "순위"
  
  colnames(data_basic_1_1)[3] <- "팀명"
  
  
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  ##                    기본기록 두번째 crwaling                               ################################
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  
  
  remDr$navigate("https://www.koreabaseball.com/Record/Team/Hitter/Basic2.aspx")
  
  
  #############################################################################################################
  #############################################################################################################
  #######################                       시즌정보 확인                 #################################
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  
  season_select <- remDr$findElement(using = 'xpath', value = sprintf('//*[@id="cphContents_cphContents_cphContents_ddlSeason_ddlSeason"]/option[%s]',i))
  
  season_select$clickElement()
  
  Sys.sleep(2)
  
  
  selectelem <- remDr$findElement(using = "xpath", '//*[@id="cphContents_cphContents_cphContents_ddlSeason_ddlSeason"]')
  
  
  season_value = selectelem$getElementAttribute("value")[[1]]
  

  webElem <-remDr$findElement(using = "class", value = "record_result")
  results <- webElem$getElementText()
  
  webElem5txt <- webElem$getElementAttribute("outerHTML")
  
  page_source <- remDr$getPageSource()
  
  data_basic_2_1 = read_html(page_source[[1]]) %>% html_nodes("table") %>% html_table() %>% extract2(1)
  
  data_basic_2_1 = data.frame(season=season_value,data_basic_2_1)
  
  colnames(data_basic_2_1)[2] <- "순위"
  
  colnames(data_basic_2_1)[3] <- "팀명"



  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  ####                      데이터 통합                                       #################################
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  #############################################################################################################
  
  Sys.setlocale("LC_ALL", "Korean")
  
  temp_df = left_join(data_basic_1_1,data_basic_2_1,by=c("팀명","AVG","순위","season"))
  
  hitter_team_base_record[[i]] = temp_df[-nrow(temp_df),]

}  
  
######################################################################
#####       데이터 저장 ##############################################
######################################################################


write.csv(bind_rows(hitter_team_base_record),"~/hitter_team_base_record.csv",row.names = FALSE)



## 셀레니움 종료

remDr$close()

## 드라이버 사용종료

rm(driver)

## 메모리 삭제

gc()